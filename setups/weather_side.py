#!/usr/bin/env python3

import flipdot
import pyowm
import time
import traceback

from owm_apikey import API_KEY

def upperfirst(x):
    return x[0].upper() + x[1:]

def _prepare_status(status):
    replacements = {
        "Überwiegend": "überw.",
        "Leichte Regenschauer": "Leichte Regensch."
    }
    status = upperfirst(status)
    for orig, repl in replacements.items():
        status = status.replace(orig, repl)
    return status

# Example data so we don't run into the API limit when testing
weather_cur_ex = {'main': {'temp_min': 288.15, 'temp': 288.86, 'pressure': 1010, 'temp_max': 289.35, 'humidity': 47}, 'dt': 1459956304, 'clouds': {'all': 75}, 'cod': 200, 'id': 2921473, 'sys': {'id': 4881, 'message': 0.0068, 'type': 3, 'sunset': 1459965888, 'country': 'DE', 'sunrise': 1459918019}, 'name': 'Gelnhausen', 'weather': [{'id': 803, 'main': 'Clouds', 'icon': '04d', 'description': 'broken clouds'}], 'base': 'cmc stations', 'wind': {'speed': 8.2, 'deg': 230}, 'rain': {}, 'coord': {'lon': 9.18, 'lat': 50.2}}
weather_fc_ex = {'cod': '200', 'list': [{'main': {'sea_level': 1023.14, 'temp': 286.78, 'temp_max': 286.78, 'grnd_level': 990.84, 'temp_min': 284.011, 'temp_kf': 2.76, 'humidity': 72, 'pressure': 990.84}, 'rain': {'3h': 0.095}, 'dt': 1459965600, 'clouds': {'all': 92}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-06 18:00:00', 'wind': {'speed': 6.26, 'deg': 230.501}}, {'main': {'sea_level': 1022.77, 'temp': 285.14, 'temp_max': 285.14, 'grnd_level': 990.33, 'temp_min': 283.068, 'temp_kf': 2.07, 'humidity': 75, 'pressure': 990.33}, 'rain': {'3h': 0.085}, 'dt': 1459976400, 'clouds': {'all': 0}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-06 21:00:00', 'wind': {'speed': 5.81, 'deg': 219.001}}, {'main': {'sea_level': 1021.85, 'temp': 283.46, 'temp_max': 283.46, 'grnd_level': 989.14, 'temp_min': 282.073, 'temp_kf': 1.38, 'humidity': 84, 'pressure': 989.14}, 'rain': {'3h': 0.38}, 'dt': 1459987200, 'clouds': {'all': 76}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-07 00:00:00', 'wind': {'speed': 6.26, 'deg': 222.503}}, {'main': {'sea_level': 1021.53, 'temp': 281.59, 'temp_max': 281.59, 'grnd_level': 988.82, 'temp_min': 280.902, 'temp_kf': 0.69, 'humidity': 100, 'pressure': 988.82}, 'rain': {'3h': 2.495}, 'dt': 1459998000, 'clouds': {'all': 80}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-07 03:00:00', 'wind': {'speed': 3.61, 'deg': 275.504}}, {'main': {'sea_level': 1021.64, 'temp': 279.802, 'temp_max': 279.802, 'grnd_level': 988.89, 'temp_min': 279.802, 'temp_kf': 0, 'humidity': 98, 'pressure': 988.89}, 'rain': {'3h': 0.465}, 'dt': 1460008800, 'clouds': {'all': 92}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-07 06:00:00', 'wind': {'speed': 2.81, 'deg': 228.001}}, {'main': {'sea_level': 1022.44, 'temp': 279.815, 'temp_max': 279.815, 'grnd_level': 989.83, 'temp_min': 279.815, 'temp_kf': 0, 'humidity': 100, 'pressure': 989.83}, 'rain': {'3h': 1.055}, 'dt': 1460019600, 'clouds': {'all': 92}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-07 09:00:00', 'wind': {'speed': 4.73, 'deg': 219.002}}, {'main': {'sea_level': 1022.91, 'temp': 280.742, 'temp_max': 280.742, 'grnd_level': 990.35, 'temp_min': 280.742, 'temp_kf': 0, 'humidity': 98, 'pressure': 990.35}, 'rain': {'3h': 0.21}, 'dt': 1460030400, 'clouds': {'all': 36}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-07 12:00:00', 'wind': {'speed': 6.17, 'deg': 237.507}}, {'main': {'sea_level': 1023.35, 'temp': 281.251, 'temp_max': 281.251, 'grnd_level': 990.81, 'temp_min': 281.251, 'temp_kf': 0, 'humidity': 92, 'pressure': 990.81}, 'rain': {}, 'dt': 1460041200, 'clouds': {'all': 20}, 'sys': {'pod': 'd'}, 'weather': [{'id': 801, 'icon': '02d', 'description': 'few clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-07 15:00:00', 'wind': {'speed': 5.44, 'deg': 261.501}}, {'main': {'sea_level': 1024.02, 'temp': 279.521, 'temp_max': 279.521, 'grnd_level': 991.26, 'temp_min': 279.521, 'temp_kf': 0, 'humidity': 84, 'pressure': 991.26}, 'rain': {}, 'dt': 1460052000, 'clouds': {'all': 0}, 'sys': {'pod': 'd'}, 'weather': [{'id': 800, 'icon': '01d', 'description': 'clear sky', 'main': 'Clear'}], 'dt_txt': '2016-04-07 18:00:00', 'wind': {'speed': 3.02, 'deg': 252.5}}, {'main': {'sea_level': 1025.16, 'temp': 277.118, 'temp_max': 277.118, 'grnd_level': 992.19, 'temp_min': 277.118, 'temp_kf': 0, 'humidity': 86, 'pressure': 992.19}, 'rain': {}, 'dt': 1460062800, 'clouds': {'all': 24}, 'sys': {'pod': 'n'}, 'weather': [{'id': 801, 'icon': '02n', 'description': 'few clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-07 21:00:00', 'wind': {'speed': 2.41, 'deg': 211.002}}, {'main': {'sea_level': 1024.84, 'temp': 276.392, 'temp_max': 276.392, 'grnd_level': 991.93, 'temp_min': 276.392, 'temp_kf': 0, 'humidity': 88, 'pressure': 991.93}, 'rain': {}, 'dt': 1460073600, 'clouds': {'all': 44}, 'sys': {'pod': 'n'}, 'weather': [{'id': 802, 'icon': '03n', 'description': 'scattered clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-08 00:00:00', 'wind': {'speed': 2.77, 'deg': 195.014}}, {'main': {'sea_level': 1024.18, 'temp': 276.188, 'temp_max': 276.188, 'grnd_level': 991.16, 'temp_min': 276.188, 'temp_kf': 0, 'humidity': 90, 'pressure': 991.16}, 'rain': {}, 'dt': 1460084400, 'clouds': {'all': 24}, 'sys': {'pod': 'n'}, 'weather': [{'id': 801, 'icon': '02n', 'description': 'few clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-08 03:00:00', 'wind': {'speed': 2.96, 'deg': 199.501}}, {'main': {'sea_level': 1024.1, 'temp': 276.355, 'temp_max': 276.355, 'grnd_level': 990.99, 'temp_min': 276.355, 'temp_kf': 0, 'humidity': 91, 'pressure': 990.99}, 'rain': {'3h': 0.02}, 'dt': 1460095200, 'clouds': {'all': 32}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-08 06:00:00', 'wind': {'speed': 2.71, 'deg': 211}}, {'main': {'sea_level': 1024.02, 'temp': 280.323, 'temp_max': 280.323, 'grnd_level': 991.19, 'temp_min': 280.323, 'temp_kf': 0, 'humidity': 100, 'pressure': 991.19}, 'rain': {'3h': 0.02}, 'dt': 1460106000, 'clouds': {'all': 20}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-08 09:00:00', 'wind': {'speed': 3.07, 'deg': 225.5}}, {'main': {'sea_level': 1023.03, 'temp': 282.149, 'temp_max': 282.149, 'grnd_level': 990.53, 'temp_min': 282.149, 'temp_kf': 0, 'humidity': 89, 'pressure': 990.53}, 'rain': {'3h': 0.005}, 'dt': 1460116800, 'clouds': {'all': 36}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-08 12:00:00', 'wind': {'speed': 2.76, 'deg': 257.5}}, {'main': {'sea_level': 1022.2, 'temp': 283.073, 'temp_max': 283.073, 'grnd_level': 989.7, 'temp_min': 283.073, 'temp_kf': 0, 'humidity': 76, 'pressure': 989.7}, 'rain': {'3h': 0.005}, 'dt': 1460127600, 'clouds': {'all': 76}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-08 15:00:00', 'wind': {'speed': 2.55, 'deg': 282.003}}, {'main': {'sea_level': 1022.39, 'temp': 281.721, 'temp_max': 281.721, 'grnd_level': 989.8, 'temp_min': 281.721, 'temp_kf': 0, 'humidity': 71, 'pressure': 989.8}, 'rain': {}, 'dt': 1460138400, 'clouds': {'all': 68}, 'sys': {'pod': 'd'}, 'weather': [{'id': 803, 'icon': '04d', 'description': 'broken clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-08 18:00:00', 'wind': {'speed': 1.36, 'deg': 293.5}}, {'main': {'sea_level': 1023.13, 'temp': 279.893, 'temp_max': 279.893, 'grnd_level': 990.35, 'temp_min': 279.893, 'temp_kf': 0, 'humidity': 74, 'pressure': 990.35}, 'rain': {}, 'dt': 1460149200, 'clouds': {'all': 88}, 'sys': {'pod': 'n'}, 'weather': [{'id': 804, 'icon': '04n', 'description': 'overcast clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-08 21:00:00', 'wind': {'speed': 1.26, 'deg': 294.005}}, {'main': {'sea_level': 1022.56, 'temp': 279.07, 'temp_max': 279.07, 'grnd_level': 989.73, 'temp_min': 279.07, 'temp_kf': 0, 'humidity': 80, 'pressure': 989.73}, 'rain': {'3h': 0.005}, 'dt': 1460160000, 'clouds': {'all': 80}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-09 00:00:00', 'wind': {'speed': 1.17, 'deg': 347.009}}, {'main': {'sea_level': 1021.39, 'temp': 277.579, 'temp_max': 277.579, 'grnd_level': 988.42, 'temp_min': 277.579, 'temp_kf': 0, 'humidity': 87, 'pressure': 988.42}, 'rain': {'3h': 0.005}, 'dt': 1460170800, 'clouds': {'all': 44}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-09 03:00:00', 'wind': {'speed': 1.29, 'deg': 35.5038}}, {'main': {'sea_level': 1020.71, 'temp': 277.725, 'temp_max': 277.725, 'grnd_level': 987.73, 'temp_min': 277.725, 'temp_kf': 0, 'humidity': 86, 'pressure': 987.73}, 'rain': {'3h': 0.015}, 'dt': 1460181600, 'clouds': {'all': 76}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-09 06:00:00', 'wind': {'speed': 1.41, 'deg': 97.0001}}, {'main': {'sea_level': 1019.82, 'temp': 281.8, 'temp_max': 281.8, 'grnd_level': 987.33, 'temp_min': 281.8, 'temp_kf': 0, 'humidity': 91, 'pressure': 987.33}, 'rain': {'3h': 0.015}, 'dt': 1460192400, 'clouds': {'all': 56}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-09 09:00:00', 'wind': {'speed': 1.92, 'deg': 140.5}}, {'main': {'sea_level': 1018.37, 'temp': 283.733, 'temp_max': 283.733, 'grnd_level': 986.05, 'temp_min': 283.733, 'temp_kf': 0, 'humidity': 77, 'pressure': 986.05}, 'rain': {}, 'dt': 1460203200, 'clouds': {'all': 76}, 'sys': {'pod': 'd'}, 'weather': [{'id': 803, 'icon': '04d', 'description': 'broken clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-09 12:00:00', 'wind': {'speed': 2.52, 'deg': 175.003}}, {'main': {'sea_level': 1017.12, 'temp': 284.124, 'temp_max': 284.124, 'grnd_level': 984.97, 'temp_min': 284.124, 'temp_kf': 0, 'humidity': 72, 'pressure': 984.97}, 'rain': {}, 'dt': 1460214000, 'clouds': {'all': 56}, 'sys': {'pod': 'd'}, 'weather': [{'id': 803, 'icon': '04d', 'description': 'broken clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-09 15:00:00', 'wind': {'speed': 2.72, 'deg': 165.501}}, {'main': {'sea_level': 1016.81, 'temp': 282.298, 'temp_max': 282.298, 'grnd_level': 984.46, 'temp_min': 282.298, 'temp_kf': 0, 'humidity': 69, 'pressure': 984.46}, 'rain': {}, 'dt': 1460224800, 'clouds': {'all': 8}, 'sys': {'pod': 'd'}, 'weather': [{'id': 800, 'icon': '02d', 'description': 'clear sky', 'main': 'Clear'}], 'dt_txt': '2016-04-09 18:00:00', 'wind': {'speed': 1.65, 'deg': 139.006}}, {'main': {'sea_level': 1016.94, 'temp': 278.809, 'temp_max': 278.809, 'grnd_level': 984.43, 'temp_min': 278.809, 'temp_kf': 0, 'humidity': 74, 'pressure': 984.43}, 'rain': {}, 'dt': 1460235600, 'clouds': {'all': 12}, 'sys': {'pod': 'n'}, 'weather': [{'id': 801, 'icon': '02n', 'description': 'few clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-09 21:00:00', 'wind': {'speed': 2.32, 'deg': 112.501}}, {'main': {'sea_level': 1015.92, 'temp': 278.092, 'temp_max': 278.092, 'grnd_level': 983.24, 'temp_min': 278.092, 'temp_kf': 0, 'humidity': 79, 'pressure': 983.24}, 'rain': {}, 'dt': 1460246400, 'clouds': {'all': 36}, 'sys': {'pod': 'n'}, 'weather': [{'id': 802, 'icon': '03n', 'description': 'scattered clouds', 'main': 'Clouds'}], 'dt_txt': '2016-04-10 00:00:00', 'wind': {'speed': 2.78, 'deg': 119.001}}, {'main': {'sea_level': 1015.32, 'temp': 278.907, 'temp_max': 278.907, 'grnd_level': 982.62, 'temp_min': 278.907, 'temp_kf': 0, 'humidity': 84, 'pressure': 982.62}, 'rain': {'3h': 0.27}, 'dt': 1460257200, 'clouds': {'all': 92}, 'sys': {'pod': 'n'}, 'weather': [{'id': 500, 'icon': '10n', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-10 03:00:00', 'wind': {'speed': 2.59, 'deg': 140.502}}, {'main': {'sea_level': 1015.09, 'temp': 279.67, 'temp_max': 279.67, 'grnd_level': 982.52, 'temp_min': 279.67, 'temp_kf': 0, 'humidity': 95, 'pressure': 982.52}, 'rain': {'3h': 0.89}, 'dt': 1460268000, 'clouds': {'all': 92}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-10 06:00:00', 'wind': {'speed': 1.96, 'deg': 160.5}}, {'main': {'sea_level': 1015.71, 'temp': 280.938, 'temp_max': 280.938, 'grnd_level': 983.31, 'temp_min': 280.938, 'temp_kf': 0, 'humidity': 100, 'pressure': 983.31}, 'rain': {'3h': 0.59}, 'dt': 1460278800, 'clouds': {'all': 88}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-10 09:00:00', 'wind': {'speed': 2.88, 'deg': 184.503}}, {'main': {'sea_level': 1016.23, 'temp': 281.256, 'temp_max': 281.256, 'grnd_level': 983.94, 'temp_min': 281.256, 'temp_kf': 0, 'humidity': 100, 'pressure': 983.94}, 'rain': {'3h': 0.46}, 'dt': 1460289600, 'clouds': {'all': 92}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-10 12:00:00', 'wind': {'speed': 4.91, 'deg': 207.001}}, {'main': {'sea_level': 1017.09, 'temp': 281.689, 'temp_max': 281.689, 'grnd_level': 984.71, 'temp_min': 281.689, 'temp_kf': 0, 'humidity': 96, 'pressure': 984.71}, 'rain': {'3h': 0.32}, 'dt': 1460300400, 'clouds': {'all': 12}, 'sys': {'pod': 'd'}, 'weather': [{'id': 500, 'icon': '10d', 'description': 'light rain', 'main': 'Rain'}], 'dt_txt': '2016-04-10 15:00:00', 'wind': {'speed': 4.47, 'deg': 233.5}}, {'main': {'sea_level': 1018.28, 'temp': 279.747, 'temp_max': 279.747, 'grnd_level': 985.76, 'temp_min': 279.747, 'temp_kf': 0, 'humidity': 89, 'pressure': 985.76}, 'rain': {}, 'dt': 1460311200, 'clouds': {'all': 0}, 'sys': {'pod': 'd'}, 'weather': [{'id': 800, 'icon': '01d', 'description': 'clear sky', 'main': 'Clear'}], 'dt_txt': '2016-04-10 18:00:00', 'wind': {'speed': 1.66, 'deg': 213.5}}, {'main': {'sea_level': 1019.37, 'temp': 276.049, 'temp_max': 276.049, 'grnd_level': 986.64, 'temp_min': 276.049, 'temp_kf': 0, 'humidity': 90, 'pressure': 986.64}, 'rain': {}, 'dt': 1460322000, 'clouds': {'all': 0}, 'sys': {'pod': 'n'}, 'weather': [{'id': 800, 'icon': '01n', 'description': 'clear sky', 'main': 'Clear'}], 'dt_txt': '2016-04-10 21:00:00', 'wind': {'speed': 1.06, 'deg': 112.004}}], 'message': 0.0369, 'cnt': 34, 'city': {'id': 2921473, 'name': 'Gelnhausen', 'coord': {'lon': 9.18333, 'lat': 50.200001}, 'population': 0, 'sys': {'population': 0}, 'country': 'DE'}}

client = flipdot.FlipdotClient("localhost")
owm = pyowm.OWM(API_KEY, language = 'de')

while True:
    try:
        obs = owm.weather_at_id(2872493)
        w = obs.get_weather()
        icon = w.get_weather_icon_name()
        temp = w.get_temperature('celsius')['temp']
        status = _prepare_status(w.get_detailed_status())
        humidity = w.get_humidity()
        wind = w.get_wind()['speed'] * 3.6 # Speed is in m/sec

        client.add_graphics_submessage('side', 'bitmap', image = "bitmaps/weather_icons/{0}.png".format(icon), x = 0, y = 0)
        client.add_graphics_submessage('side', 'text', text = status, font = "Flipdot8_Narrow", x = 18, y = 0)
        client.add_graphics_submessage('side', 'text', text = "{0:.1f}°C {1}% {2:.0f}km/h".format(temp, humidity, wind), font = "Flipdot8_Narrow", x = 18, y = 9)

        client.commit()
    except:
        traceback.print_exc()

    time.sleep(10 * 60)
